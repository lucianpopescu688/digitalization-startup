<%- include('../layout', { body: %>
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome back, <%= user.username %>!</h1>
        <% if (user.company_name) { %>
        <p class="company-info">Company: <%= user.company_name %></p>
        <% } %>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-number"><%= stats.totalVideos %></div>
            <div class="stat-label">Total Videos</div>
        </div>
        <div class="stat-card">
            <div class="stat-number"><%= stats.userVideos %></div>
            <div class="stat-label">Your Videos</div>
        </div>
        <% if (stats.companyVideos > 0) { %>
        <div class="stat-card">
            <div class="stat-number"><%= stats.companyVideos %></div>
            <div class="stat-label">Company Videos</div>
        </div>
        <% } %>
    </div>

    <div class="dashboard-actions">
        <a href="/videos/upload" class="btn btn-primary">
            <span class="btn-icon">+</span>
            Upload New Video
        </a>
        <a href="/dashboard/search" class="btn btn-secondary">
            <span class="btn-icon">üîç</span>
            Search Videos
        </a>
    </div>

    <div class="video-section">
        <h2>Recent Videos</h2>
        
        <% if (videos && videos.length > 0) { %>
        <div class="video-grid">
            <% videos.forEach(video => { %>
            <div class="video-card" onclick="openVideo(<%= video.id %>)">
                <div class="video-thumbnail">
                    <div class="video-play-button">‚ñ∂</div>
                    <div class="video-duration">
                        <% if (video.duration) { %>
                        <%= Math.floor(video.duration / 60) %>:<%= (video.duration % 60).toString().padStart(2, '0') %>
                        <% } else { %>
                        --:--
                        <% } %>
                    </div>
                </div>
                
                <div class="video-info">
                    <h3 class="video-title"><%= video.title || video.original_name %></h3>
                    <p class="video-meta">
                        Uploaded by <%= video.username || 'Unknown' %> ‚Ä¢ 
                        <%= new Date(video.upload_date).toLocaleDateString() %>
                    </p>
                    <% if (video.description) { %>
                    <p class="video-description"><%= video.description.substring(0, 100) %><%= video.description.length > 100 ? '...' : '' %></p>
                    <% } %>
                    <% if (video.tags) { %>
                    <div class="video-tags">
                        <% video.tags.split(',').slice(0, 3).forEach(tag => { %>
                        <span class="tag"><%= tag.trim() %></span>
                        <% }) %>
                    </div>
                    <% } %>
                </div>

                <div class="video-actions">
                    <button onclick="event.stopPropagation(); editVideo(<%= video.id %>)" class="btn btn-small btn-secondary">Edit</button>
                    <% if (user.role === 'admin' || video.user_id === user.id) { %>
                    <button onclick="event.stopPropagation(); deleteVideo(<%= video.id %>, '<%= video.title || video.original_name %>')" class="btn btn-small btn-danger">Delete</button>
                    <% } %>
                </div>
            </div>
            <% }) %>
        </div>
        <% } else { %>
        <div class="empty-state">
            <div class="empty-icon">üìπ</div>
            <h3>No videos yet</h3>
            <p>Upload your first video to get started digitizing your archive!</p>
            <a href="/videos/upload" class="btn btn-primary">Upload Video</a>
        </div>
        <% } %>
    </div>

    <div class="dashboard-footer">
        <div class="quick-links">
            <h3>Quick Links</h3>
            <ul>
                <li><a href="/dashboard/account">Account Settings</a></li>
                <% if (user.role === 'admin') { %>
                <li><a href="/admin">Admin Panel</a></li>
                <% } %>
                <% if (user.company_id) { %>
                <li><a href="/admin/companies/<%= user.company_id %>">Company Management</a></li>
                <% } %>
                <li><a href="/dashboard/the-box">The Box - Coming Soon</a></li>
                <li><a href="/dashboard/contact">Contact Support</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Confirm Delete</h3>
        <p id="deleteMessage">Are you sure you want to delete this video?</p>
        <div class="modal-actions">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmDelete()" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<script>
let videoToDelete = null;

function openVideo(videoId) {
    window.open(`/videos/${videoId}`, '_blank');
}

function editVideo(videoId) {
    window.location.href = `/videos/${videoId}/edit`;
}

function deleteVideo(videoId, videoTitle) {
    videoToDelete = videoId;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${videoTitle}"? This action cannot be undone.`;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    videoToDelete = null;
}

function confirmDelete() {
    if (videoToDelete) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/videos/${videoToDelete}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
<% }) %>